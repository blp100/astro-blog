---
import { contentfulClient } from "../../lib/contentful";
import type { BlogPost, HeroImage } from "../../lib/contentful";
import { getLangFromUrl, useTranslations } from "../../i18n/utils";
import BlogPostList from "../../components/BlogPostList.astro";
import IndexLayout from "../../layouts/IndexLayout.astro";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const entries = await contentfulClient.getEntries<BlogPost>({
  content_type: "astroBlog",
  locale: t("contentful.locale"),
  order: ["-sys.createdAt"],
  limit: 7,
});

const posts = entries.items.map((item) => {
  const { updatedAt } = item.sys;
  const { title, date, description, slug, heroImage, content } = item.fields;
  return {
    title,
    slug,
    description,
    heroImage: (heroImage as HeroImage).fields.file.url,
    pubDate: new Date(date),
    updatedDate: new Date(updatedAt),
    content: content.toString(),
  };
});
---

<IndexLayout>
  {
    posts.map((post) => {
      const {
        slug,
        title,
        updatedDate,
        pubDate,
        description,
        heroImage,
        content,
      } = post;
      return (
        <BlogPostList
          lang={lang}
          slug={slug}
          title={title}
          updatedDate={updatedDate}
          pubDate={pubDate}
          description={description}
          heroImage={heroImage}
          content={content}
        />
      );
    })
  }
</IndexLayout>
