---
import { useTranslations } from "../../../i18n/utils";
import FilteredListLayout from "../../../layouts/FilteredListLayout.astro";
import MainLayout from "../../../layouts/MainLayout.astro";
import { contentfulClient } from "../../../lib/contentful";
import type { BlogPost, BlogTags, Category, Tags } from "../../../lib/contentful";
import FilteredList from "../../../components/FilteredList.astro";

export async function getStaticPaths() {
  const t = useTranslations("en");
  const { items } = await contentfulClient.getEntries<BlogTags>({
    content_type: "astroTags",
    locale: t("contentful.locale"),
    order: ["-sys.createdAt"],
    limit: 15,
  });

  const pages = items.map((item) => {
    const { title, slug } = item.fields;
    const id = item.sys.id;
    return {
      params: { slug: slug },
      props: {
        title,
        slug,
        id,
      },
    };
  });
  return pages;
}

const { title, id } = Astro.props;
const { slug } = Astro.params;

const lang = "en";
const t = useTranslations(lang);
const entries =
  await contentfulClient.withoutUnresolvableLinks.getEntries<BlogPost>({
    content_type: "astroBlog",
    locale: t("contentful.locale"),
    order: ["-sys.createdAt"],
    limit: 15,
    links_to_entry: id,
  });
  
const posts = entries.items.map((item) => {
  const { title, date, slug, category } = item.fields;
    const id = item.sys.id;
  return {
    title,
    postSlug: slug,
    pubDate: new Date(date),
    category: (category as Category).fields.slug,
  };
});
let recordYear: string;
---

<MainLayout>
  <FilteredListLayout lang={lang}>
    {
      posts.map((post) => {
        const { title, postSlug, pubDate } = post;

        const year = pubDate.toLocaleDateString(lang, {
          year: "numeric",
        });

        const toggleYearColumn: boolean = recordYear != year;
        recordYear = year;

        return (
          <FilteredList
            lang={lang}
            title={title}
            slug={postSlug}
            pubDate={pubDate}
            toggleYearColumn={toggleYearColumn}
            year={year}
          />
        );
      })
    }
  </FilteredListLayout>
</MainLayout>
